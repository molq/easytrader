# 日志系统优化更新说明

## 更新概述

本次更新对 easytrader 项目的日志记录系统进行了全面优化，实现了分类日志记录，使项目日志更加清晰、易于追踪和分析。

## 主要改进

### 1. 三类独立日志文件

- **主日志** (`logs/easytrader.log`)
  - 记录所有常规系统日志
  - 包含详细的文件名、行号信息
  - 同时输出到控制台和文件

- **跟单日志** (`logs/follow.log`)
  - 专门记录策略跟踪信息
  - 记录指令生成、处理和执行过程
  - 仅写入文件，格式简洁易读

- **交易日志** (`logs/trade.log`)
  - 专门记录买卖交易操作
  - 记录订单提交和执行结果
  - 仅写入文件，格式简洁易读

### 2. 日志轮转机制

- 单文件最大 10MB
- 自动轮转，保留最近 10 个备份
- UTF-8 编码，支持中文

### 3. 向后兼容

- 保持原有 API 不变
- 现有代码无需修改即可工作
- 新增功能可选使用

## 文件变更

### 核心文件

1. **easytrader/log.py** - 完全重构
   - 新增 `LogManager` 类管理日志配置
   - 导出 `logger`, `follow_logger`, `trade_logger`
   - 支持日志轮转和文件管理

2. **easytrader/follower.py** - 增强日志
   - 导入 `follow_logger`
   - 在关键操作点添加跟单日志
   - 记录策略信息、指令处理、执行结果

3. **easytrader/xq_follower.py** - 增强日志
   - 导入 `follow_logger`
   - 记录雪球特定的跟单信息
   - 记录调仓记录和持仓调整

4. **easytrader/clienttrader.py** - 增强日志
   - 导入 `trade_logger`
   - 记录所有交易操作（买入、卖出、撤单等）
   - 记录操作参数和执行结果

5. **easytrader/webtrader.py** - 增强日志
   - 导入 `trade_logger`
   - 记录登录状态和异常情况

### 新增文件

1. **tests/test_logging.py** - 日志测试脚本
   - 测试三种日志记录器功能
   - 验证日志文件创建
   - 生成示例日志

2. **docs/logging.md** - 日志系统文档
   - 详细说明日志系统使用方法
   - 包含示例和故障排查指南

3. **LOGGING_UPDATE.md** - 本文件
   - 更新说明和使用指南

## 使用示例

### 查看日志

```bash
# 查看主日志
cat logs/easytrader.log

# 查看跟单日志
cat logs/follow.log

# 查看交易日志
cat logs/trade.log

# 实时监控日志
tail -f logs/follow.log
```

### 在代码中使用

```python
from easytrader.log import logger, follow_logger, trade_logger

# 主日志 - 系统级消息
logger.info("系统启动")
logger.error("发生错误: %s", error_msg)

# 跟单日志 - 策略跟踪
follow_logger.info("策略[%s] 新指令 - 股票:%s 动作:%s", 
                   strategy, stock, action)

# 交易日志 - 交易操作
trade_logger.info("买入 - 证券:%s 价格:%.2f 数量:%d", 
                  security, price, amount)
```

## 测试验证

运行测试脚本验证日志系统：

```bash
python tests/test_logging.py
```

预期输出：
- 创建 `logs/` 目录
- 生成三个日志文件
- 显示测试结果和文件信息

## 日志示例

### 跟单日志示例

```
2025-12-03 23:05:17 [INFO] 跟单系统登录成功
2025-12-03 23:05:17 [INFO] 开始跟踪雪球策略: 测试策略 (ID:ZH123456 资产:100000.00)
2025-12-03 23:05:17 [INFO] 策略[测试策略] 新指令 - 股票:sh600000 动作:buy 数量:1000 价格:10.50 时间:2024-01-01 10:00:00
2025-12-03 23:05:17 [INFO] 策略[测试策略] 指令执行成功 - 股票:sh600000 动作:buy 数量:1000 价格:10.55 结果:{'entrust_no': '123456'}
2025-12-03 23:05:17 [WARNING] 策略[测试策略] 指令超时被丢弃 - 股票:sh600001 动作:sell 超时:130.5秒
```

### 交易日志示例

```
2025-12-03 23:05:17 [INFO] 自动登录成功
2025-12-03 23:05:17 [INFO] 买入 - 证券:sh600000 价格:10.50 数量:1000
2025-12-03 23:05:17 [INFO] 买入结果 - 证券:sh600000 结果:{'entrust_no': '123456'}
2025-12-03 23:05:17 [INFO] 卖出 - 证券:sh600001 价格:15.80 数量:500
2025-12-03 23:05:17 [INFO] 卖出结果 - 证券:sh600001 结果:{'entrust_no': '123457'}
```

## 优势

1. **清晰分类** - 不同类型的日志分开记录，便于查找和分析
2. **信息完整** - 记录关键操作的输入参数和执行结果
3. **易于追踪** - 跟单和交易流程清晰可追溯
4. **自动管理** - 日志轮转自动进行，无需手动清理
5. **向后兼容** - 不影响现有代码运行

## 注意事项

1. 首次运行会自动创建 `logs/` 目录
2. 日志文件使用 UTF-8 编码
3. 建议定期备份或清理旧的日志文件
4. 生产环境建议配置日志级别和轮转参数

## 后续改进建议

1. 添加日志级别配置选项
2. 支持自定义日志目录
3. 添加更多的结构化日志字段
4. 考虑集成日志分析工具
5. 添加日志压缩功能

## 技术细节

- **实现方式**: Python logging 模块
- **日志处理器**: RotatingFileHandler
- **设计模式**: 单例模式（LogManager）
- **代码位置**: `easytrader/log.py`

## 相关文档

- [日志系统详细文档](docs/logging.md)
- [测试脚本](tests/test_logging.py)

---

更新日期: 2025-12-03
版本: 1.0.0