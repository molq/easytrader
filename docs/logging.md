# 日志系统说明

## 概述

easytrader 项目已升级日志系统，现在支持三种独立的日志文件：

1. **主日志** (`logs/easytrader.log`) - 记录所有常规日志信息
2. **跟单日志** (`logs/follow.log`) - 专门记录策略跟踪和指令处理信息
3. **交易日志** (`logs/trade.log`) - 专门记录买卖交易操作信息

## 日志文件位置

所有日志文件默认存储在项目根目录下的 `logs/` 目录中：

```
easytrader/
├── logs/
│   ├── easytrader.log      # 主日志文件
│   ├── follow.log           # 跟单日志文件
│   └── trade.log            # 交易日志文件
```

## 日志轮转

日志系统支持自动轮转，配置如下：
- **单个日志文件最大大小**: 10MB
- **保留备份数量**: 10个
- **编码格式**: UTF-8

当日志文件达到10MB时，系统会自动创建备份文件（如 `easytrader.log.1`, `easytrader.log.2` 等）。

## 日志格式

### 主日志格式
```
2025-12-03 23:05:17 [INFO] [easytrader] test_logging.py:19 - 这是主日志的INFO消息
```
格式说明：`时间戳 [日志级别] [logger名称] 文件名:行号 - 消息内容`

### 跟单日志格式
```
2025-12-03 23:05:17 [INFO] 策略[测试策略] 新指令 - 股票:sh600000 动作:buy 数量:1000 价格:10.50
```
格式说明：`时间戳 [日志级别] 消息内容`

### 交易日志格式
```
2025-12-03 23:05:17 [INFO] 买入 - 证券:sh600000 价格:10.50 数量:1000
```
格式说明：`时间戳 [日志级别] 消息内容`

## 跟单日志记录内容

跟单日志（`follow.log`）记录以下关键信息：

1. **系统登录**
   ```
   跟单系统登录成功
   雪球跟单系统登录成功
   ```

2. **策略跟踪**
   ```
   开始跟踪雪球策略: 策略名称 (ID:ZH123456 资产:100000.00)
   ```

3. **交易指令**
   ```
   策略[策略名] 新指令 - 股票:sh600000 动作:buy 数量:1000 价格:10.50 时间:2024-01-01 10:00:00
   策略[策略名] 指令已处理过，跳过 - 股票:sh600000 动作:buy 数量:1000 价格:10.50
   ```

4. **指令执行结果**
   ```
   策略[策略名] 指令执行成功 - 股票:sh600000 动作:buy 数量:1000 价格:10.55 结果:{'entrust_no': '123456'}
   策略[策略名] 指令执行失败 - 股票:sh600000 动作:buy 数量:1000 价格:10.50 错误:资金不足
   ```

5. **异常情况**
   ```
   策略[策略名] 指令超时被丢弃 - 股票:sh600001 动作:sell 超时:130.5秒
   策略[策略名] 指令价格无效被丢弃 - 股票:sh600000 价格:-1.0
   策略[策略名] 指令数量无效被丢弃 - 股票:sh600000 数量:0
   ```

6. **持仓调整**
   ```
   调整卖出数量 - 股票:600000 原数量:1000 可用:800 调整后:800
   调整卖出数量时发现未持有股票: 600001, 保持原数量:1000
   ```

## 交易日志记录内容

交易日志（`trade.log`）记录以下关键信息：

1. **登录状态**
   ```
   自动登录成功
   账户异常，尝试重新登录: Connection error
   ```

2. **买入操作**
   ```
   买入 - 证券:sh600000 价格:10.50 数量:1000
   买入结果 - 证券:sh600000 结果:{'entrust_no': '123456'}
   ```

3. **卖出操作**
   ```
   卖出 - 证券:sh600001 价格:15.80 数量:500
   卖出结果 - 证券:sh600001 结果:{'entrust_no': '123457'}
   ```

4. **市价交易**
   ```
   市价买入 - 证券:sh600000 数量:1000 类型:对手方最优价格
   市价买入结果 - 证券:sh600000 结果:{'entrust_no': '123458'}
   市价卖出 - 证券:sh600001 数量:500 类型:默认
   市价卖出结果 - 证券:sh600001 结果:{'entrust_no': '123459'}
   ```

5. **撤单操作**
   ```
   撤单操作 - 委托号:123456 结果:{'message': 'success'}
   撤单失败 - 委托号:123458 原因:委托单状态错误不能撤单
   全部撤单操作完成
   ```

6. **回购操作**
   ```
   正回购 - 证券:131810 价格:2.500 数量:1000
   正回购结果 - 证券:131810 结果:{'entrust_no': '123460'}
   逆回购 - 证券:204001 价格:2.800 数量:10000
   逆回购结果 - 证券:204001 结果:{'entrust_no': '123461'}
   ```

7. **新股申购**
   ```
   新股申购 - 共3只新股，可申购2只
   新股申购结果: {'message': 'success'}
   新股申购 - 今日无新股
   新股申购 - 没有可申购的新股
   ```

## 开发者使用

### 导入日志记录器

```python
from easytrader.log import logger, follow_logger, trade_logger

# 使用主日志
logger.info("这是主日志消息")
logger.warning("这是警告消息")
logger.error("这是错误消息")

# 使用跟单日志
follow_logger.info("策略[%s] 新指令 - 股票:%s", strategy_name, stock_code)

# 使用交易日志
trade_logger.info("买入 - 证券:%s 价格:%.2f 数量:%d", security, price, amount)
```

### 获取日志记录器

```python
from easytrader.log import get_logger, get_follow_logger, get_trade_logger

# 获取主日志记录器
logger = get_logger()

# 获取跟单日志记录器
follow_logger = get_follow_logger()

# 获取交易日志记录器  
trade_logger = get_trade_logger()
```

## 日志级别

所有日志记录器支持以下级别：
- `DEBUG` - 调试信息
- `INFO` - 一般信息
- `WARNING` - 警告信息
- `ERROR` - 错误信息
- `CRITICAL` - 严重错误

默认级别为 `INFO`，只有主日志会输出到控制台，跟单和交易日志仅写入文件。

## 测试日志系统

运行测试脚本验证日志系统：

```bash
python tests/test_logging.py
```

测试脚本会：
1. 测试三种日志记录器的基本功能
2. 生成示例日志条目
3. 验证日志文件是否正确创建
4. 显示日志文件的位置和大小

## 注意事项

1. **向后兼容**: 现有代码中的 `from easytrader.log import logger` 仍然有效
2. **自动创建**: `logs/` 目录会在首次使用时自动创建
3. **文件权限**: 确保应用程序有权限在项目目录下创建和写入文件
4. **磁盘空间**: 注意监控日志文件大小，虽然有自动轮转但长期运行仍需定期清理旧备份

## 故障排查

### 日志文件未创建
- 检查应用程序是否有写入权限
- 确认 `logs/` 目录是否存在
- 查看是否有文件系统错误

### 日志内容为空
- 确认已正确导入日志记录器
- 检查日志级别设置
- 验证日志记录语句是否被执行

### 控制台无输出
- 只有主日志（`logger`）会输出到控制台
- 跟单和交易日志仅写入文件
- 检查日志级别是否正确设置