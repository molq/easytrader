# 优化版跟单程序使用说明

## 概述

`mytest_optimized.py` 是一个完整优化的跟单程序，支持从雪球平台跟随策略进行自动交易。

## 主要功能特性

### 1. 可靠性保障
- ✅ **自动重连机制**：连接断开后自动重连，无需人工干预
- ✅ **异常处理**：完整的异常捕获和错误恢复机制
- ✅ **重试机制**：关键操作（连接、登录）支持自动重试
- ✅ **优雅退出**：支持 Ctrl+C 安全退出，正确释放资源

### 2. 监控与日志
- ✅ **健康检查**：定期监控连接状态，及时发现问题
- ✅ **详细日志**：完整记录所有操作和异常，便于问题排查
- ✅ **双重日志**：同时记录到控制台和专用的跟单日志文件

### 3. 交易保护
- ✅ **指令缓存**：防止重复执行已处理的交易指令
- ✅ **超时保护**：过期的交易指令自动丢弃
- ✅ **滑点设置**：支持配置交易滑点
- ✅ **连接验证**：执行交易前自动验证连接状态

## 使用前准备

### 1. 安装依赖
```bash
pip install easytrader
```

### 2. 准备 QMT 客户端
- 安装国金 QMT 交易端
- 登录客户端时**必须勾选极简模式/独立交易模式**
- 保持客户端处于登录状态

### 3. 获取雪球 Cookies
访问 https://www.xueqiu.com，登录后在浏览器开发者工具中获取 cookies

## 配置说明

在 `mytest_optimized.py` 中修改以下配置：

### 1. MiniQMT 连接配置
```python
MINIQMT_CONFIG = {
    'miniqmt_path': r"D:\国金QMT交易端模拟\userdata_mini",  # QMT 安装路径
    'stock_account': "62500888",                              # 资金账号
    'reconnect_enabled': True,                                # 启用自动重连
    'reconnect_interval': 5,                                  # 重连间隔（秒）
    'max_reconnect_attempts': 0,                              # 最大重连次数（0=无限）
}
```

**重要参数说明：**
- `miniqmt_path`: MiniQMT 的安装路径，通常在 QMT 客户端目录下的 `userdata_mini` 文件夹
- `stock_account`: 您的资金账号
- `reconnect_enabled`: 建议保持为 `True`，启用自动重连
- `reconnect_interval`: 重连间隔时间，建议 5-10 秒
- `max_reconnect_attempts`: 设为 0 表示无限重连，设为正数则限制重连次数

### 2. 雪球配置
```python
XUEQIU_CONFIG = {
    'cookies': "您的雪球 cookies 字符串"
}
```

**获取 cookies 步骤：**
1. 浏览器访问 https://www.xueqiu.com 并登录
2. 按 F12 打开开发者工具
3. 切换到 "Network" 标签
4. 刷新页面
5. 找到任意请求，在 Request Headers 中复制 Cookie 字段的值

### 3. 跟单配置
```python
FOLLOW_CONFIG = {
    'strategies': ["ZH3381319"],      # 跟随的雪球组合代码
    'initial_assets': 100000,          # 初始资金（元）
    'track_interval': 10,              # 轮询间隔（秒）
    'trade_cmd_expire_seconds': 120,   # 交易指令过期时间（秒）
    'cmd_cache': True,                 # 是否缓存已执行指令
    'slippage': 0.0,                   # 滑点设置（0.05 = 5%）
}
```

**参数说明：**
- `strategies`: 要跟随的雪球组合代码列表，可以跟随多个组合
- `initial_assets`: 对应组合的初始资金，用于计算交易数量
- `track_interval`: 查询组合调仓的时间间隔，建议 10-30 秒
- `trade_cmd_expire_seconds`: 交易指令的有效期，超时自动丢弃
- `cmd_cache`: 建议为 `True`，防止重启后重复执行
- `slippage`: 滑点补偿，买入时提高价格，卖出时降低价格

## 运行程序

### 启动
```bash
python tests/mytest_optimized.py
```

### 停止
- 按 `Ctrl+C` 优雅退出
- 程序会自动：
  - 停止自动重连
  - 清理资源
  - 记录退出日志

## 运行流程

程序启动后会按以下步骤执行：

1. **连接 MiniQMT**
   - 尝试连接到 QMT 交易端
   - 验证连接成功
   - 显示账户资金和持仓信息

2. **登录雪球**
   - 使用 cookies 登录雪球平台
   - 验证登录状态

3. **启动健康监控**
   - 后台线程每 60 秒检查连接状态
   - 发现异常时记录警告

4. **开始跟单**
   - 定期查询雪球组合调仓
   - 自动执行买卖指令
   - 记录所有交易

## 异常处理说明

### 连接失败

**现象：** 无法连接到 MiniQMT

**可能原因：**
- QMT 客户端未登录
- 未勾选极简模式/独立交易模式
- 路径配置错误
- 权限不足

**解决方案：**
1. 确保 QMT 客户端已登录并勾选极简模式
2. 检查 `miniqmt_path` 配置是否正确
3. 尝试以管理员权限运行程序
4. 程序会自动重试 3 次，每次间隔 5 秒

### 连接断开

**现象：** 运行中连接突然断开

**自动处理：**
- 立即触发自动重连机制
- 后台持续尝试重连（间隔 5 秒）
- 重连成功后自动恢复跟单

**人工干预：**
- 如果长时间无法重连，检查 QMT 客户端状态
- 检查网络连接
- 查看日志了解详细错误信息

### 交易失败

**常见原因：**
- 非交易时间
- 资金不足
- 股票停牌
- 价格异常

**处理方式：**
- 程序记录错误日志但继续运行
- 不会终止跟单
- 查看日志了解失败原因

## 日志查看

### 控制台日志
实时显示程序运行状态、交易指令、异常信息

### 文件日志
- 主日志：`logs/easytrader.log`
- 跟单日志：`logs/follow.log`

**日志内容包括：**
- 连接状态变化
- 交易指令详情
- 执行结果
- 异常和错误信息
- 健康检查结果

## 安全建议

1. **资金安全**
   - 建议先使用模拟盘测试
   - 设置合理的初始资金
   - 定期检查交易记录

2. **配置安全**
   - 妥善保管 cookies（定期更新）
   - 不要分享包含敏感信息的配置文件
   - 建议将配置移到单独的配置文件

3. **运行安全**
   - 保持 QMT 客户端稳定运行
   - 网络环境稳定
   - 定期查看日志
   - 监控账户变化

## 常见问题

### Q1: 程序启动后立即退出？
**A:** 检查配置是否正确，查看日志文件了解详细错误

### Q2: 连接成功但不执行交易？
**A:** 可能是：
- 雪球组合未调仓
- cookies 已过期
- 交易指令已缓存（重启后不会重复执行）

### Q3: 如何重新执行历史指令？
**A:** 删除 `cmd_cache.pk` 文件（谨慎操作，可能导致重复交易）

### Q4: 程序占用资源多吗？
**A:** 非常低，主要是轮询检查，不会持续占用 CPU

### Q5: 可以同时跟随多个组合吗？
**A:** 可以，在 `strategies` 中添加多个组合代码

### Q6: 重连失败怎么办？
**A:** 
- 检查 QMT 客户端状态
- 手动重启程序
- 检查网络连接

## 技术支持

- 项目地址: https://github.com/shidenggui/easytrader
- 文档: https://github.com/shidenggui/easytrader/blob/master/README.md
- 问题反馈: 通过 GitHub Issues 提交

## 更新日志

### v1.0 (优化版)
- ✅ 添加完整的异常处理机制
- ✅ 实现自动重连功能
- ✅ 添加健康监控
- ✅ 支持优雅退出
- ✅ 增强日志记录
- ✅ 添加连接验证和重试机制

---

**免责声明：** 本程序仅供学习和研究使用。使用本程序进行实盘交易可能存在风险，请谨慎使用。使用者需自行承担所有交易风险。